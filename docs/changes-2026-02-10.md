# Changes (2026-02-10)

## Summary

This update focuses on:

- Restoring/adding the "expected" CI/CD functionality described in `README.md` (Tekton listener/pipelinerun correctness, show README task).
- Hardening the demo Node app against common correctness/security issues without reducing performance.
- Adding automated tests and a lightweight performance check to prevent regressions.
- Cleaning up repo hygiene around secrets and committed artifacts.
- Improving local developer experience (scripts, Docker Compose refactor, multi-stage Dockerfile).
- Adding CI checks and basic lint/format tooling.

## Node App

- Refactored routing into an app factory (`app.js`) and made `server.js` a thin runtime entrypoint.
  - Rationale: enables dependency injection for testing and keeps runtime startup concerns separate.
- Added `/healthz` endpoint for basic readiness/liveness checks.
- Prevented stored XSS by escaping user-controlled fields when rendering `views/profile.html`.
- Added basic validation/normalization:
  - Invalid or missing fields on `/register` return `400`.
  - Invalid ObjectId-like values on `/profile` and `/update` return `400` instead of bubbling errors.
  - Minimal email validation and max-length caps for text fields to avoid abuse.
- Updates now request validator enforcement via `{ runValidators: true }` for Mongoose updates.
- Added basic fixed-window rate limiting (in-memory) with stricter limits on mutating routes.
- Added optional Basic Auth guard on `/update` (enabled by setting `UPDATE_BASIC_AUTH_USER` and `UPDATE_BASIC_AUTH_PASS`).

Performance impact:

- Profile template is cached at startup to avoid per-request disk reads.

## Tests

- Added Node-native tests (`node:test`) under `tests/` with an in-memory fake model.
  - Rationale: avoids external services (Mongo) and avoids binding network ports in restricted CI/sandbox environments.
- `npm test` now runs the suite.

## Performance Check

- Added `npm run perf` (`perf/basic.js`) as a micro-benchmark for template rendering and HTML escaping.
  - Intended to catch accidental performance regressions (e.g., O(n^2) string work).

## Tekton / CI Manifests

- Moved manifests into a standard structure under `manifests/` (Tekton vs runtime Kubernetes).
- Fixed invalid EventListener YAML structure (`manifests/tekton/triggers/event-listener.yaml`) by placing `triggers` under `spec`.
- Updated PipelineRun to reference the existing pipeline (`manifests/tekton/runs/pipelinerun.yaml`).
- Updated the pipeline to actually run the `show-readme` task (`manifests/tekton/pipeline/pipeline.yaml`) and updated the Task to print a README (`manifests/tekton/tasks/show-readme.yaml`).
- Added persistent caching and scanning integration:
  - Cache PVC manifest: `manifests/tekton/pvc/cache-pvc.yaml` (claim `tekton-cache-pvc`)
  - Added cache workspace to TriggerTemplate + PipelineRun + Pipeline
  - Added in-repo tasks:
    - Trivy scan: `manifests/tekton/tasks/trivy-sca-scan.yaml`
    - NPM test: `manifests/tekton/tasks/npm-test.yaml`
    - SonarQube scan: `manifests/tekton/tasks/sonarqube-scan.yaml` (optional; needs `sonarqube-credentials` secret)
    - Vendored external dependencies to make the pipeline reproducible:
      - `git-clone`: `manifests/tekton/tasks/git-clone.yaml`
      - `kaniko`: `manifests/tekton/tasks/kaniko.yaml`
  - Triggered and manual PipelineRuns now set `serviceAccountName: tekton-triggers-sa`
- Added walkthrough documentation for applying Tekton and triggering runs:
  - `docs/tekton-walkthrough.md`

## Secrets / Repo Hygiene

- Added a root `.gitignore` to prevent committing `node_modules/`, `.env`, and coverage artifacts.
- Added `.env.example` and updated Docker Compose to use `.env` interpolation.
- Sanitized secret manifests (`manifests/tekton/secrets/git-ssh-secret.yaml`, `manifests/tekton/secrets/docker-credentials.yaml`) to remove committed secret material from the working tree (history still needs rotation and rewriting if this was ever real).
- Stopped tracking `node_modules/` and `.env` in git (these should not live in the repository).

## Docker / Compose

- Refactored `docker-compose.yaml` for cleaner structure and safer defaults:
  - isolated internal DB network
  - healthchecks for Mongo and the app
  - shared logging config and a dedicated `node_modules` volume
  - optional production-like profile for the app service
- Added a multi-stage `Dockerfile` (dev vs prod deps) and container `HEALTHCHECK` hitting `/healthz`.
- Added `.dockerignore` to keep build context small and avoid copying `node_modules/`, manifests, and docs into images.

## Developer Experience

- Added runnable scripts:
  - `scripts/start.sh`, `scripts/stop.sh` (Compose up/down)
  - `scripts/tests.sh` (tests + perf check)
- Added lint/format tooling and config:
  - `.editorconfig`, `.eslintrc.cjs`, `.prettierrc.json`, `.prettierignore`
  - `npm run lint`, `npm run format`, `npm run format:check`
- Added GitHub Actions CI for PRs:
  - `.github/workflows/ci.yml` (lint, tests, perf, `npm audit`)
