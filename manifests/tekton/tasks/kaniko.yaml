
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: kaniko
spec:
  description: Build and push with date-stamped tag
  
  params:
    - name: IMAGE
      type: string
      description: Base image name (without tag)
    - name: CONTEXT
      default: "."
    - name: DOCKERFILE
      default: "Dockerfile"

  workspaces:
    - name: source
    - name: dockerconfig

  results:
    - name: IMAGE_DIGEST
      description: Image digest
    - name: IMAGE_URL
      description: Full image URL with date tag
    - name: IMAGE_TAG
      description: The date-stamped tag that was created

  volumes:
    - name: kaniko-docker
      emptyDir: {}

  steps:
    - name: setup-credentials
      image: alpine:latest
      volumeMounts:
        - name: kaniko-docker
          mountPath: /kaniko/.docker
      script: |
        #!/bin/sh
        set -eu
        mkdir -p /kaniko/.docker
        if [ -f "$(workspaces.dockerconfig.path)/config.json" ]; then
          cp $(workspaces.dockerconfig.path)/config.json /kaniko/.docker/config.json
          echo "âœ… Docker credentials configured"
        else
          echo "âŒ Missing config.json" >&2
          exit 2
        fi

    - name: generate-tag
      image: alpine/git:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -e
        
        # Generate date-stamped tag: YYYYMMDD-HHMMSS-gitsha
        DATE_TAG=$(date -u +"%Y%m%d-%H%M%S")
        GIT_SHORT_SHA=$(git rev-parse --short=7 HEAD 2>/dev/null || echo "local")
        
        IMAGE_TAG="${DATE_TAG}-${GIT_SHORT_SHA}"
        
        echo "Generated tag: $IMAGE_TAG"
        echo -n "$IMAGE_TAG" > /tekton/results/IMAGE_TAG

    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.23.2
      volumeMounts:
        - name: kaniko-docker
          mountPath: /kaniko/.docker
      env:
        - name: DOCKER_CONFIG
          value: /kaniko/.docker
      script: |
        #!/busybox/sh
        set -e
        
        # Read the generated tag
        IMAGE_TAG=$(cat $(results.IMAGE_TAG.path))
        IMAGE_REPO="$(params.IMAGE)"
        FULL_IMAGE="${IMAGE_REPO}:${IMAGE_TAG}"
        
        echo "=========================================="
        echo "ðŸ”¨ Building and pushing image"
        echo "Repository: $IMAGE_REPO"
        echo "Tag: $IMAGE_TAG"
        echo "Full image: $FULL_IMAGE"
        echo "=========================================="
        
        /kaniko/executor \
          --context=dir://$(workspaces.source.path)/$(params.CONTEXT) \
          --dockerfile=$(workspaces.source.path)/$(params.DOCKERFILE) \
          --destination=${FULL_IMAGE} \
          --destination=${IMAGE_REPO}:latest \
          --digest-file=$(results.IMAGE_DIGEST.path) \
          --snapshotMode=redo \
          --verbosity=info \
          --skip-tls-verify
        
        # Save full image URL to result
        echo -n "$FULL_IMAGE" > $(results.IMAGE_URL.path)
        
        echo "âœ… Pushed: $FULL_IMAGE"
        echo "âœ… Pushed: ${IMAGE_REPO}:latest"
