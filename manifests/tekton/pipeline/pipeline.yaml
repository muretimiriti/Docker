apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: tekton-trigger-listeners
spec:
  description: |
    This pipeline clones a git repo, runs tests, scans, and builds a Docker image.
    Cache is managed sequentially to avoid PVC binding conflicts.

  params:
    - name: repo-url
      type: string
      description: The git repo URL to clone from

    - name: image-reference
      type: string
      description: The image reference to build and push

    - name: run-sonarqube
      type: string
      default: "false"
      description: "Set to true to run SonarQube scan"

  workspaces:
    - name: shared-data
      description: Workspace for cloned source code
    - name: docker-credentials
      description: Workspace for docker credentials
    - name: cache
      description: Persistent cache workspace (npm, trivy, sonar)

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 1: Clone source code
    # Workspaces: shared-data only
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: fetch-source
      taskRef:
        name: git-clone
      params:
        - name: url
          value: $(params.repo-url)
      workspaces:
        - name: output
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 2: Restore cache to shared-data
    # Workspaces: shared-data + cache
    # Cache is mounted HERE first
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: restore-cache
      runAfter:
        - fetch-source
      taskSpec:
        workspaces:
          - name: source
          - name: cache
        steps:
          - name: restore
            image: alpine
            script: |
              #!/bin/sh
              set -e

              echo "=========================================="
              echo "ğŸ”„ Restoring cache..."
              echo "=========================================="

              # Restore node_modules
              if [ -d "$(workspaces.cache.path)/node_modules" ]; then
                echo "âœ… Cache hit! Restoring node_modules..."
                cp -r $(workspaces.cache.path)/node_modules \
                      $(workspaces.source.path)/node_modules
              else
                echo "âš ï¸  Cache miss - node_modules not cached"
              fi

              # Restore npm cache
              if [ -d "$(workspaces.cache.path)/.npm" ]; then
                echo "âœ… Cache hit! Restoring .npm cache..."
                cp -r $(workspaces.cache.path)/.npm \
                      $(workspaces.source.path)/.npm
              else
                echo "âš ï¸  Cache miss - .npm not cached"
              fi

              # Restore trivy cache
              if [ -d "$(workspaces.cache.path)/.trivy" ]; then
                echo "âœ… Cache hit! Restoring trivy cache..."
                cp -r $(workspaces.cache.path)/.trivy \
                      $(workspaces.source.path)/.trivy
              else
                echo "âš ï¸  Cache miss - trivy cache not found"
              fi

              # Restore sonar cache
              if [ -d "$(workspaces.cache.path)/.sonar" ]; then
                echo "âœ… Cache hit! Restoring sonar cache..."
                cp -r $(workspaces.cache.path)/.sonar \
                      $(workspaces.source.path)/.sonar
              else
                echo "âš ï¸  Cache miss - sonar cache not found"
              fi

              echo "=========================================="
              echo "âœ… Cache restore complete"
              echo "=========================================="
      workspaces:
        - name: source
          workspace: shared-data
        - name: cache
          workspace: cache              # â† cache mounted here ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 3: Run npm tests
    # Workspaces: shared-data ONLY
    # cache PVC is RELEASED after restore-cache
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: npm-test
      runAfter:
        - restore-cache
      taskRef:
        name: npm-test
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 4: Show README
    # Workspaces: shared-data ONLY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: show-readme
      runAfter:
        - npm-test
      taskRef:
        name: show-readme
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 5: Debug workspace
    # Workspaces: shared-data ONLY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: debug-workspace
      runAfter:
        - show-readme
      taskSpec:
        workspaces:
          - name: source
        steps:
          - name: list-workspace
            image: alpine
            script: |
              echo "Workspace contents:"
              ls -R /workspace
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 6: SCA Scan
    # Workspaces: shared-data ONLY
    # Uses trivy cache copied to shared-data
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: sca-scan
      runAfter:
        - debug-workspace
      taskRef:
        name: trivy-sca-scan
      params:
        - name: SEVERITY
          value: "HIGH,CRITICAL"
        - name: SCAN_MODE
          value: fs
        - name: TARGET
          value: .
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 7: SonarQube scan (conditional)
    # Workspaces: shared-data ONLY
    # Uses sonar cache copied to shared-data
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: sonarqube-scan
      runAfter:
        - npm-test
      when:
        - input: "$(params.run-sonarqube)"
          operator: in
          values: ["true"]
      taskRef:
        name: sonarqube-scan
      params:
        - name: WORKDIR
          value: .
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 8: Save cache back
    # Workspaces: shared-data + cache
    # Cache is mounted HERE again AFTER all tasks
    # that needed it are done
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: save-cache
      runAfter:
        - sca-scan
        - sonarqube-scan
      taskSpec:
        workspaces:
          - name: source
          - name: cache
        steps:
          - name: save
            image: alpine
            script: |
              #!/bin/sh
              set -e

              echo "=========================================="
              echo "ğŸ’¾ Saving cache..."
              echo "=========================================="

              # Save node_modules
              if [ -d "$(workspaces.source.path)/node_modules" ]; then
                echo "Saving node_modules..."
                rm -rf $(workspaces.cache.path)/node_modules
                cp -r $(workspaces.source.path)/node_modules \
                      $(workspaces.cache.path)/node_modules
                echo "âœ… node_modules saved"
              fi

              # Save npm cache
              if [ -d "$(workspaces.source.path)/.npm" ]; then
                echo "Saving .npm cache..."
                rm -rf $(workspaces.cache.path)/.npm
                cp -r $(workspaces.source.path)/.npm \
                      $(workspaces.cache.path)/.npm
                echo "âœ… .npm cache saved"
              fi

              # Save trivy cache
              if [ -d "$(workspaces.source.path)/.trivy" ]; then
                echo "Saving trivy cache..."
                rm -rf $(workspaces.cache.path)/.trivy
                cp -r $(workspaces.source.path)/.trivy \
                      $(workspaces.cache.path)/.trivy
                echo "âœ… trivy cache saved"
              fi

              # Save sonar cache
              if [ -d "$(workspaces.source.path)/.sonar" ]; then
                echo "Saving sonar cache..."
                rm -rf $(workspaces.cache.path)/.sonar
                cp -r $(workspaces.source.path)/.sonar \
                      $(workspaces.cache.path)/.sonar
                echo "âœ… sonar cache saved"
              fi

              echo "=========================================="
              echo "Cache contents:"
              du -sh $(workspaces.cache.path)/* 2>/dev/null || echo "Cache empty"
              echo "âœ… Cache save complete"
              echo "=========================================="
      workspaces:
        - name: source
          workspace: shared-data
        - name: cache
          workspace: cache              # â† cache mounted here ONLY

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 9: Build and push image
    # Workspaces: shared-data + docker-credentials
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: build-push
      runAfter:
        - save-cache
      taskRef:
        name: kaniko
      params:
        - name: IMAGE
          value: $(params.image-reference)
        - name: CONTEXT
          value: .
        - name: DOCKERFILE
          value: Dockerfile
      workspaces:
        - name: source
          workspace: shared-data        # â† shared-data ONLY
        - name: dockerconfig
          workspace: docker-credentials # â† Secret, not PVC
